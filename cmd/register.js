// Generated by CoffeeScript 1.10.0
(function() {
  var bcrypt, util, validator;

  bcrypt = require('bcryptjs');

  validator = require('validator');

  util = require('./util');

  module.exports = function(options) {
    var acl, mail, seneca;
    seneca = this;
    mail = seneca.client(options.mail);
    acl = options.acl;
    seneca.add('plugin:register', function(args, respond) {
      var email, password;
      email = args.email;
      password = args.password || util.generate_password();
      if (!validator.isEmail(email)) {
        respond(seneca.fail("Bad email: " + email));
      }
      return seneca.act('plugin:identify', {
        account_id: email
      }, function(error, account) {
        if (account) {
          return respond(seneca.fail('Already registered'));
        } else {
          return bcrypt.genSalt(10, function(error, salt) {
            return bcrypt.hash(password, salt, function(error, hash) {
              var new_account;
              new_account = seneca.make('account');
              new_account.id = email;
              new_account.password_hash = hash;
              new_account.group = 'general';
              return new_account.save$(function(error, saved_account) {
                return acl.addUserRoles(saved_account.id, ['player'], function(error) {
                  if (error) {
                    seneca.log.error('role assignment failed', saved_account.id);
                    return respond(error);
                  } else {
                    saved_account.password = password;
                    if (!options.test) {
                      mail.act({
                        action: 'send',
                        to: email,
                        subject: 'Регистрация в Venture Game',
                        text: 'Поздравляем с регистрацией!\n' + '---------------------------\n' + 'Ваш пароль: ' + password
                      });
                    }
                    return respond(null, saved_account);
                  }
                });
              });
            });
          });
        }
      });
    });
    return 'register';
  };

}).call(this);

//# sourceMappingURL=register.js.map
